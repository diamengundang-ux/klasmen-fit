<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Klasmen FIT FC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .delete-btn {
            background-color: #fee2e2; color: #ef4444;
            border: none; border-radius: 50%;
            width: 24px; height: 24px;
            font-weight: bold; font-size: 14px;
            line-height: 24px; text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .delete-btn:hover { background-color: #ef4444; color: white; }
        
        /* CSS UNTUK TOMBOL EDIT */
        .edit-btn {
            background-color: #dbeafe; color: #3b82f6; /* Blue */
            border: none; border-radius: 50%;
            width: 24px; height: 24px;
            font-weight: bold; font-size: 14px;
            line-height: 24px; text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 4px; /* Jarak dari tombol hapus */
        }
        .edit-btn:hover { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto max-w-7xl">

        <!-- ===== BAGIAN AUTENTIKASI (LOGIN/REGISTER) ===== -->
        <div id="auth-view" class="flex items-center justify-center min-h-[80vh]">
            <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
                <div class="flex items-center gap-4 mb-6">
                    <img src="https://audio.diamengundang.id/LOGO%2022.png" alt="Logo Sepakbola" class="w-12 h-12 object-contain">
                    <h1 class="text-2xl font-bold text-gray-800">Klasemen FIT FC</h1>
                </div>
                
                <form id="login-form" class="space-y-4">
                    <h2 class="text-xl font-semibold">Login</h2>
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="login-email" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold">Login</button>
                </form>

                <p id="auth-error" class="text-red-500 text-sm mt-4"></p>
            </div>
        </div>

        <!-- ===== BAGIAN APLIKASI UTAMA (Tersembunyi by default) ===== -->
        <div id="app-view" class="hidden">
            
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4">
                    <img src="https://audio.diamengundang.id/LOGO%2022.png" alt="Logo Sepakbola" class="w-12 h-12 object-contain">
                    <h4 class="text-3xl font-bold text-gray-800">Aplikasi Klasmen FIT FC</h4>
                </div>
                <div>
                    <span id="user-email" class="text-sm text-gray-600 mr-4"></span>
                    <button id="logout-button" class="bg-red-500 text-white py-2 px-4 rounded-md text-sm font-semibold">Logout</button>
                </div>
            </div>

            <!-- Grid Utama -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- KOLOM KIRI: Input Form -->
                <div class="lg:col-span-1 flex flex-col gap-6">

                    <!-- Card: Tambah Tim -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Input Tim Baru</h2>
                        <form id="add-team-form">
                            <div class="mb-4">
                                <label for="team_name" class="block text-sm font-medium text-gray-700 mb-1">Nama Tim</label>
                                <input type="text" id="team_name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold">
                                Tambah Tim
                            </button>
                        </form>
                    </div>

                    <!-- Card: Input Pertandingan -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Input Hasil Pertandingan</h2>
                        <form id="add-match-form" class="space-y-4">
                            <div>
                                <label for="team_a" class="block text-sm font-medium text-gray-700">Tim Tuan Rumah (A)</label>
                                <select id="team_a" class="w-full mt-1 p-2 border border-gray-300 rounded-md"></select>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <label for="score_a" class="block text-sm font-medium text-gray-700">Skor A</label>
                                    <input type="number" id="score_a" min="0" value="0" class="w-full mt-1 p-2 border border-gray-300 rounded-md text-center">
                                </div>
                                <span class="mt-6 font-bold text-gray-500">-</span>
                                <div class="flex-1">
                                    <label for="score_b" class="block text-sm font-medium text-gray-700">Skor B</label>
                                    <input type="number" id="score_b" min="0" value="0" class="w-full mt-1 p-2 border border-gray-300 rounded-md text-center">
                                </div>
                            </div>
                            <div>
                                <label for="team_b" class="block text-sm font-medium text-gray-700">Tim Tamu (B)</label>
                                <select id="team_b" class="w-full mt-1 p-2 border border-gray-300 rounded-md"></select>
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-semibold">
                                Simpan Pertandingan
                            </button>
                        </form>
                    </div>
                </div>

                <!-- KOLOM KANAN: Tabel Klasemen & Riwayat -->
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <!-- Card Klasemen Liga -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Klasemen Liga</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max text-left text-sm">
                                <thead class="border-b-2 border-gray-200">
                                    <tr class="text-gray-600 font-semibold">
                                        <th class="p-3">No</th>
                                        <th class="p-3">Nama Tim</th>
                                        <th class="p-3 text-center" title="Main">M</th>
                                        <th class="p-3 text-center" title="Menang">M</th>
                                        <th class="p-3 text-center" title="Seri">S</th>
                                        <th class="p-3 text-center" title="Kalah">K</th>
                                        <th class="p-3 text-center" title="Selisih Gol (GF-GA)">SG</th>
                                        <th class="p-3 text-center" title="Poin">Poin</th>
                                        <th class="p-3 text-center">3 Laga Terakhir</th>
                                        <th class="p-3 text-center">Aksi</th> <!-- BARU: Kolom Aksi -->
                                    </tr>
                                </thead>
                                <tbody id="standings-table-body">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- CARD BARU: Riwayat Pertandingan -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Riwayat Pertandingan</h2>
                        <!-- PERUBAHAN DI SINI: tambahkan overflow-x-auto -->
                        <div class="overflow-y-auto max-h-64 overflow-x-auto">
                             <table class="w-full text-left text-sm min-w-[400px]"> <!-- Tambahkan min-w agar tidak terlalu sempit -->
                                <thead>
                                    <tr class="border-b text-gray-600">
                                        <th class="p-2 w-12 text-center">No</th>
                                        <th class="p-2">Tuan Rumah</th>
                                        <th class="p-2 text-center">Skor</th>
                                        <th class="p-2">Tamu</th>
                                        <th class="p-2 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="match-history-body">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Baris Baru: Top Skor & Top Assist -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- Card: Top Skor -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Top Skor</h2>
                    <form id="add-scorer-form" class="grid grid-cols-3 gap-4 mb-4">
                        <input type="text" id="scorer-player-name" placeholder="Nama Pemain" class="col-span-3 sm:col-span-1 p-2 border rounded-md" required>
                        <select id="scorer-team-name" class="col-span-3 sm:col-span-1 p-2 border rounded-md" required>
                            <option value="">Pilih Tim</option>
                        </select>
                        <input type="number" id="scorer-goals" placeholder="Jml Gol" min="1" class="col-span-3 sm:col-span-1 p-2 border rounded-md" required>
                        <button type="submit" class="col-span-3 bg-blue-500 text-white py-2 rounded-md font-semibold">Update Gol</button>
                    </form>
                    <!-- PERUBAHAN DI SINI: Tambahkan div wrapper -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm min-w-[300px]">
                            <thead>
                                <tr class="border-b text-gray-600">
                                <th class="p-2 text-right">Gol</th>
                                </tr>
                            </thead>
                            <tbody id="scorers-table-body">
                               <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div> <!-- Akhir div wrapper -->
                </div>
                
                <!-- Card: Top Assist -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Top Assist</h2>
                    <form id="add-assist-form" class="grid grid-cols-3 gap-4 mb-4">
                        <input type="text" id="assist-player-name" placeholder="Nama Pemain" class="col-span-3 sm:col-span-1 p-2 border rounded-md" required>
                         <select id="assist-team-name" class="col-span-3 sm:col-span-1 p-2 border rounded-md" required>
                            <option value="">Pilih Tim</option>
                        </select>
                        <input type="number" id="assist-assists" placeholder="Jml Assist" min="1" class="col-span-3 sm:col-span-1 p-2 border rounded-md" required>
                        <button type="submit" class="col-span-3 bg-blue-500 text-white py-2 rounded-md font-semibold">Update Assist</button>
                    </form>
                    <!-- PERUBAHAN DI SINI: Tambahkan div wrapper -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm min-w-[300px]">
                            <thead>
                                 <tr class="border-b text-gray-600">
                                <th class="p-2 text-right">Assist</th>
                                </tr>
                            </thead>
                            <tbody id="assists-table-body">
                               <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div> <!-- Akhir div wrapper -->
                </div>
            </div>
        </div>
    </div>

    <!-- ===== BAGIAN MODAL KUSTOM (BARU) ===== -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="modal-title" class="text-xl font-semibold mb-4">Judul Modal</h2>
            <p id="modal-message" class="text-gray-700 mb-4">Pesan modal.</p>
            
            <!-- Input untuk Edit Skor (disembunyikan by default) -->
            <div id="modal-inputs" class="space-y-4 mb-4 hidden">
                <div>
                    <label id="modal-label-a" for="modal-input-a" class="block text-sm font-medium text-gray-700">Skor A</label>
                    <input type="number" id="modal-input-a" min="0" class="w-full mt-1 p-2 border border-gray-300 rounded-md text-center">
                </div>
                 <div>
                    <label id="modal-label-b" for="modal-input-b" class="block text-sm font-medium text-gray-700">Skor B</label>
                    <input type="number" id="modal-input-b" min="0" class="w-full mt-1 p-2 border border-gray-300 rounded-md text-center">
                </div>
            </div>

            <!-- Tombol Aksi -->
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md font-semibold hover:bg-gray-400">Batal</button>
                <button id="modal-ok-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>
    <!-- ===== AKHIR MODAL KUSTOM ===== -->

    <!-- ===================================================================== -->
    <!-- SCRIPT JAVASCRIPT & FIREBASE -->
    <!-- ===================================================================== -->
    
    <!-- Import Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            getDocs, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            query, 
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. KONFIGURASI FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBJjNIH6E47Iqtul0Cj-6awqMeEFLQ_60Q",
          authDomain: "fit-fc.firebaseapp.com",
          projectId: "fit-fc",
          storageBucket: "fit-fc.firebasestorage.app",
          messagingSenderId: "914814128199",
          appId: "1:914814128199:web:d17cc61f239278e7a4a162", 
          measurementId: "G-BCG9L0R15Q"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. GLOBAL STATE & DOM ELEMENTS ---
        let currentUserId = null;
        let teamsData = {}; // Kumpulan tim (Object)
        let matchesData = []; // Daftar laga (Array)
        let scorersData = []; // Daftar skor (Array)
        let assistsData = []; // Daftar assist (Array)
        let prevPositions = {}; // Lacak posisi lama { 'NamaTim': 1, ... }
        
        let teamsListener = null;
        let matchesListener = null;
        let scorersListener = null;
        let assistsListener = null;

        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        
        const loginForm = document.getElementById('login-form');
        const authError = document.getElementById('auth-error');
        const logoutButton = document.getElementById('logout-button');
        const userEmailSpan = document.getElementById('user-email');
        
        const addTeamForm = document.getElementById('add-team-form');
        const addMatchForm = document.getElementById('add-match-form');
        const addScorerForm = document.getElementById('add-scorer-form');
        const addAssistForm = document.getElementById('add-assist-form');
        
        const teamNameInput = document.getElementById('team_name');
        const teamADropdown = document.getElementById('team_a');
        const teamBDropdown = document.getElementById('team_b');
        const scorerTeamDropdown = document.getElementById('scorer-team-name');
        const assistTeamDropdown = document.getElementById('assist-team-name');
        
        const standingsBody = document.getElementById('standings-table-body');
        const matchHistoryBody = document.getElementById('match-history-body');
        const scorersBody = document.getElementById('scorers-table-body');
        const assistsBody = document.getElementById('assists-table-body');

        // --- 2.5. LOGIKA MODAL KUSTOM (BARU) ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInputs = document.getElementById('modal-inputs');
        const modalLabelA = document.getElementById('modal-label-a');
        const modalInputA = document.getElementById('modal-input-a');
        const modalLabelB = document.getElementById('modal-label-b');
        const modalInputB = document.getElementById('modal-input-b');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let modalResolve = null; // Global promise resolver

        // Fungsi untuk reset/sembunyikan modal
        function hideModal() {
            modal.classList.add('hidden');
            modalInputs.classList.add('hidden');
            modalMessage.classList.remove('hidden');
            modalOkBtn.style.display = 'inline-flex';
            modalCancelBtn.style.display = 'inline-flex';
            if (modalResolve) {
                modalResolve(null); // Resolve with null if closed unexpectedly
                modalResolve = null;
            }
        }

        // Tiga fungsi utama untuk modal
        function showCustomAlert(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            modalInputs.classList.add('hidden');
            modalMessage.classList.remove('hidden');
            modalCancelBtn.style.display = 'none'; // Sembunyikan Batal

            modal.classList.remove('hidden');

            return new Promise((resolve) => {
                modalResolve = resolve;
            });
        }

        function showCustomConfirm(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            modalInputs.classList.add('hidden');
            modalMessage.classList.remove('hidden');
            modalCancelBtn.style.display = 'inline-flex';

            modal.classList.remove('hidden');

            return new Promise((resolve) => {
                modalResolve = resolve;
            });
        }

        function showCustomPrompt(title, labelA, labelB, valueA, valueB) {
            modalTitle.textContent = title;
            modalMessage.classList.add('hidden'); // Sembunyikan pesan
            
            modalInputs.classList.remove('hidden'); // Tampilkan input
            modalLabelA.textContent = `Skor ${labelA}`;
            modalLabelB.textContent = `Skor ${labelB}`;
            modalInputA.value = valueA;
            modalInputB.value = valueB;
            
            modalCancelBtn.style.display = 'inline-flex';

            modal.classList.remove('hidden');

            return new Promise((resolve) => {
                modalResolve = resolve;
            });
        }

        // Event listener untuk tombol modal
        modalOkBtn.addEventListener('click', () => {
            if (!modalResolve) return;

            // Cek apakah ini mode prompt
            if (!modalInputs.classList.contains('hidden')) {
                modalResolve({
                    scoreA: parseInt(modalInputA.value, 10),
                    scoreB: parseInt(modalInputB.value, 10)
                });
            } else {
                modalResolve(true); // Untuk confirm atau alert
            }
            modalResolve = null;
            modal.classList.add('hidden');
        });

        modalCancelBtn.addEventListener('click', () => {
            if (!modalResolve) return;
            
            modalResolve(null); // Untuk confirm (false) atau prompt (null)
            modalResolve = null;
            modal.classList.add('hidden');
        });
        // --- AKHIR LOGIKA MODAL ---

        
        // --- 3. LOGIKA AUTENTIKASI ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email;
                authView.classList.add('hidden');
                appView.classList.remove('hidden');
                loadAllData(currentUserId);
            } else {
                currentUserId = null;
                authView.classList.remove('hidden');
                appView.classList.add('hidden');
                
                if (teamsListener) teamsListener();
                if (matchesListener) matchesListener();
                if (scorersListener) scorersListener();
                if (assistsListener) assistsListener();
                
                clearUI();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                authError.textContent = '';
            } catch (error) {
                authError.textContent = `Error: ${error.message}`;
            }
        });

        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });
        
        function clearUI() {
            teamsData = {};
            matchesData = [];
            scorersData = [];
            assistsData = [];
            prevPositions = {};
            standingsBody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500">Silakan login...</td></tr>';
            matchHistoryBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">...</td></tr>';
            scorersBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">...</td></tr>';
            assistsBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-gray-500">...</td></tr>';
        }

        // --- 4. PATH HELPER (Jalur Database) ---
        
        function getTeamsCollection(userId) {
            return collection(db, 'users', userId, 'teams');
        }
        function getMatchesCollection(userId) {
            return collection(db, 'users', userId, 'matches');
        }
        function getScorersCollection(userId) {
            return collection(db, 'users', userId, 'scorers');
        }
        function getAssistsCollection(userId) {
            return collection(db, 'users', userId, 'assists');
        }
        
        // --- 5. LOGIKA DATA (CRUD & LISTENERS) ---
        
        function loadAllData(userId) {
            
            const teamsQuery = query(getTeamsCollection(userId));
            teamsListener = onSnapshot(teamsQuery, (snapshot) => {
                teamsData = {};
                let teamNames = [];
                snapshot.docs.forEach(doc => {
                    const team = { ...doc.data(), id: doc.id };
                    teamsData[team.name] = team;
                    teamNames.push(team.name);
                });
                teamNames.sort();
                updateDropdowns(teamNames);
                renderStandings(); 
            });
            
            const matchesQuery = query(getMatchesCollection(userId));
            matchesListener = onSnapshot(matchesQuery, (snapshot) => {
                matchesData = []; 
                snapshot.docs.forEach(doc => {
                    matchesData.push({ ...doc.data(), id: doc.id });
                });
                renderMatchHistory();
                renderStandings(); 
            });

            const scorersQuery = query(getScorersCollection(userId));
            scorersListener = onSnapshot(scorersQuery, (snapshot) => {
                scorersData = [];
                snapshot.docs.forEach(doc => {
                    scorersData.push({ ...doc.data(), id: doc.id });
                });
                renderScorers();
            });

            const assistsQuery = query(getAssistsCollection(userId));
            assistsListener = onSnapshot(assistsQuery, (snapshot) => {
                assistsData = [];
                snapshot.docs.forEach(doc => {
                    assistsData.push({ ...doc.data(), id: doc.id });
                });
                renderAssists();
            });
        }
        
        // --- Form Handlers ---

        addTeamForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teamName = teamNameInput.value.trim();
            if (teamName && currentUserId && !teamsData[teamName]) {
                try {
                    await addDoc(getTeamsCollection(currentUserId), {
                        name: teamName,
                        prev_pos: 999 
                    });
                    teamNameInput.value = ''; 
                } catch (error) {
                    console.error("Error adding team: ", error);
                    await showCustomAlert("Error", "Gagal menambah tim. Cek console (F12) untuk error.");
                }
            }
        });
        
        addMatchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teamA = teamADropdown.value;
            const teamB = teamBDropdown.value;
            const scoreA = parseInt(document.getElementById('score_a').value, 10);
            const scoreB = parseInt(document.getElementById('score_b').value, 10);
            
            if (teamA !== teamB && currentUserId) {
                try {
                    await addDoc(getMatchesCollection(currentUserId), {
                        team_a: teamA,
                        score_a: scoreA,
                        team_b: teamB,
                        score_b: scoreB,
                        createdAt: new Date().toISOString()
                    });
                    document.getElementById('score_a').value = 0;
                    document.getElementById('score_b').value = 0;
                } catch (error) {
                    console.error("Error adding match: ", error);
                    await showCustomAlert("Error", "Gagal menambah laga. Cek console (F12) untuk error.");
                }
            }
        });
        
        addScorerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const player = document.getElementById('scorer-player-name').value.trim();
            const team = document.getElementById('scorer-team-name').value;
            const goals = parseInt(document.getElementById('scorer-goals').value, 10);
            
            if (!player || !team || goals <= 0 || !currentUserId) return;

            const existingScorer = scorersData.find(s => s.player === player);
            
            try {
                if (existingScorer) {
                    const docRef = doc(getScorersCollection(currentUserId), existingScorer.id);
                    await updateDoc(docRef, {
                        goals: existingScorer.goals + goals,
                        team: team
                    });
                } else {
                    await addDoc(getScorersCollection(currentUserId), {
                        player: player,
                        team: team,
                        goals: goals
                    });
                }
                document.getElementById('scorer-player-name').value = '';
                document.getElementById('scorer-goals').value = '';
            } catch (error) {
                console.error("Error adding scorer: ", error);
                await showCustomAlert("Error", "Gagal menambah top skor. Cek console (F12) untuk error.");
            }
        });
        
        addAssistForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const player = document.getElementById('assist-player-name').value.trim();
            const team = document.getElementById('assist-team-name').value;
            const assists = parseInt(document.getElementById('assist-assists').value, 10);
            
            if (!player || !team || assists <= 0 || !currentUserId) return;

            const existingAssist = assistsData.find(a => a.player === player);
            
            try {
                if (existingAssist) {
                    const docRef = doc(getAssistsCollection(currentUserId), existingAssist.id);
                    await updateDoc(docRef, {
                        assists: existingAssist.assists + assists,
                        team: team
                    });
                } else {
                    await addDoc(getAssistsCollection(currentUserId), {
                        player: player,
                        team: team,
                        assists: assists
                    });
                }
                document.getElementById('assist-player-name').value = '';
                document.getElementById('assist-assists').value = '';
            } catch (error) {
                console.error("Error adding assist: ", error);
                await showCustomAlert("Error", "Gagal menambah top assist. Cek console (F12) untuk error.");
            }
        });
        
        // --- 6. LOGIKA RENDER (TAMPILAN) ---

        function updateDropdowns(teamNames) {
            const optionsHtml = teamNames.map(name => `<option value="${name}">${name}</option>`).join('');
            
            teamADropdown.innerHTML = optionsHtml;
            teamBDropdown.innerHTML = optionsHtml;
            scorerTeamDropdown.innerHTML = `<option value="">Pilih Tim</option>` + optionsHtml;
            assistTeamDropdown.innerHTML = `<option value="">Pilih Tim</option>` + optionsHtml;
        }

        async function renderStandings() {
            if (!currentUserId || Object.keys(teamsData).length === 0) {
                standingsBody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500">Belum ada tim di klasemen.</td></tr>'; // Ubah colspan
                return;
            }
            
            let standingsData = {};
            for (const name in teamsData) {
                standingsData[name] = {
                    name: name,
                    played: 0, w: 0, d: 0, l: 0,
                    gf: 0, ga: 0, gd: 0, pts: 0,
                    form: [],
                    prev_pos: teamsData[name].prev_pos || 0,
                    id: teamsData[name].id // Simpan doc ID
                };
            }
            
            matchesData.forEach(match => {
                const { team_a, team_b, score_a, score_b } = match;
                
                if (standingsData[team_a] && standingsData[team_b]) {
                    const teamAStats = standingsData[team_a];
                    const teamBStats = standingsData[team_b];

                    teamAStats.played++;
                    teamBStats.played++;
                    teamAStats.gf += score_a;
                    teamAStats.ga += score_b;
                    teamBStats.gf += score_b;
                    teamBStats.ga += score_a;

                    if (score_a > score_b) {
                        teamAStats.w++; teamBStats.l++;
                        teamAStats.form.push('W'); teamBStats.form.push('L');
                    } else if (score_a < score_b) {
                        teamAStats.l++; teamBStats.w++;
                        teamAStats.form.push('L'); teamBStats.form.push('W');
                    } else {
                        teamAStats.d++; teamBStats.d++;
                        teamAStats.form.push('D'); teamBStats.form.push('D');
                    }
                }
            });

            let standings = Object.values(standingsData).map(stats => {
                stats.gd = stats.gf - stats.ga;
                stats.pts = (stats.w * 3) + stats.d;
                stats.form = stats.form.slice(-3); 
                return stats;
            });
            
            standings.sort((a, b) => {
                if (a.pts !== b.pts) return b.pts - a.pts;
                if (a.gd !== b.gd) return b.gd - a.gd;
                if (a.gf !== b.gf) return b.gf - a.gf;
                return a.name.localeCompare(b.name);
            });
            
            let html = '';
            let currentPositions = {}; 
            
            standings.forEach((team, index) => {
                const no = index + 1;
                currentPositions[team.name] = no; 
                
                const oldPos = prevPositions[team.name] || team.prev_pos; 
                let icon = '';
                
                if (oldPos != 0 && oldPos != 999) { 
                    if (no < oldPos) {
                        icon = `<span class="text-green-500 font-bold ml-1" title="Naik dari pos ${oldPos}">&#9650;</span>`;
                    } else if (no > oldPos) {
                        icon = `<span class="text-red-500 font-bold ml-1" title="Turun dari pos ${oldPos}">&#9660;</span>`;
                    }
                }

                let formHtml = '';
                const formDisplay = Array(3 - team.form.length).fill('N').concat(team.form);
                formDisplay.forEach(result => {
                    let className = '', text = '';
                    switch (result) {
                        case 'W': className = 'bg-green-500 text-white'; text = 'W'; break;
                        case 'D': className = 'bg-yellow-500 text-white'; text = 'D'; break;
                        case 'L': className = 'bg-red-500 text-white'; text = 'L'; break;
                        case 'N': className = 'bg-gray-300 text-gray-700'; text = '-'; break;
                    }
                    formHtml += `<span class="w-6 h-6 flex items-center justify-center rounded font-bold text-xs mx-0.5 ${className}">${text}</span>`;
                });

                html += `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-3 font-medium">${no}</td>
                        <td class="p-3 font-semibold text-gray-800">
                            <div class="flex items-center">
                                <span>${team.name}</span>
                                ${icon}
                            </div>
                        </td>
                        <td class="p-3 text-center">${team.played}</td>
                        <td class="p-3 text-center text-green-600">${team.w}</td>
                        <td class="p-3 text-center text-yellow-600">${team.d}</td>
                        <td class="p-3 text-center text-red-600">${team.l}</td>
                        <td class="p-3 text-center">${team.gd} (${team.gf}-${team.ga})</td>
                        <td class="p-3 text-center font-bold text-blue-600">${team.pts}</td>
                        <td class="p-3"><div class="flex justify-center items-center">${formHtml}</div></td>
                        <!-- BARU: Kolom Aksi dengan Tombol Hapus Tim -->
                        <td class="p-3 text-center">
                            <button class="delete-btn" 
                                    data-id="${team.id}" 
                                    data-name="${team.name}" 
                                    data-type="team-delete" 
                                    title="Hapus Tim ${team.name}">&times;</button>
                        </td>
                    </tr>
                `;
            });
            
            standingsBody.innerHTML = html || '<tr><td colspan="10" class="p-4 text-center text-gray-500">Mulai input tim dan pertandingan.</td></tr>'; // Ubah colspan
            
            prevPositions = {}; 
            standings.forEach(async (team, index) => {
                const newPos = index + 1;
                prevPositions[team.name] = newPos; 
                
                if (teamsData[team.name] && teamsData[team.name].prev_pos !== newPos) {
                    try {
                        const teamDocRef = doc(getTeamsCollection(currentUserId), team.id); 
                        await updateDoc(teamDocRef, { prev_pos: newPos });
                    } catch (e) {
                        // Biarkan saja
                    }
                }
            });
        }
        
        function renderMatchHistory() {
            if (!currentUserId) return;
            
            matchesData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '';
            let matchNumber = matchesData.length;
            
            matchesData.forEach(match => {
                html += `
                    <tr class="border-b border-gray-100">
                        <td class="p-2 text-center text-gray-600">${matchNumber}</td>
                        <td class="p-2 font-medium">${match.team_a}</td>
                        <td class="p-2 text-center font-bold">${match.score_a} - ${match.score_b}</td>
                        <td class="p-2 font-medium">${match.team_b}</td>
                        <td class="p-2 text-center">
                            <div class="flex justify-center items-center">
                                <button class="edit-btn" data-id="${match.id}" data-type="match-edit" title="Edit Skor">&#9998;</button>
                                <button class="delete-btn" data-id="${match.id}" data-type="match-delete" title="Hapus">&times;</button>
                            </div>
                        </td>
                    </tr>
                `;
                matchNumber--;
            });
            matchHistoryBody.innerHTML = html || '<tr><td colspan="5" class="p-3 text-center text-gray-500">Belum ada data pertandingan.</td></tr>';
        }
        
        function renderScorers() {
            if (!currentUserId) return;
            
            scorersData.sort((a, b) => b.goals - a.goals);
            
            let html = '';
            scorersData.slice(0, 10).forEach(scorer => {
                html += `
                    <tr class="border-b border-gray-100">
                        <td class="p-2 font-medium">${scorer.player}</td>
                        <td class="p-2 text-gray-600">${scorer.team}</td>
                        <td class="p-2 text-right font-bold">${scorer.goals}</td>
                        <td class="p-2 text-center">
                            <button class="delete-btn" data-id="${scorer.id}" data-type="scorer-delete" title="Hapus">&times;</button>
                        </td>
                    </tr>
                `;
            });
            scorersBody.innerHTML = html || '<tr><td colspan="4" class="p-3 text-center text-gray-500">Belum ada data.</td></tr>';
        }
        
        function renderAssists() {
            if (!currentUserId) return;
            
            assistsData.sort((a, b) => b.assists - a.assists);
            
            let html = '';
            assistsData.slice(0, 10).forEach(assist => {
                html += `
                    <tr class="border-b border-gray-100">
                        <td class="p-2 font-medium">${assist.player}</td>
                        <td class="p-2 text-gray-600">${assist.team}</td>
                        <td class="p-2 text-right font-bold">${assist.assists}</td>
                        <td class="p-2 text-center">
                            <button class="delete-btn" data-id="${assist.id}" data-type="assist-delete" title="Hapus">&times;</button>
                        </td>
                    </tr>
                `;
            });
            assistsBody.innerHTML = html || '<tr><td colspan="4" class="p-3 text-center text-gray-500">Belum ada data.</td></tr>';
        }
        
        // --- 7. EVENT LISTENER UNTUK HAPUS & EDIT (DI-UPGRADE) ---
        appView.addEventListener('click', async (e) => {
            
            const targetButton = e.target.closest('button');
            if (!targetButton) return; 

            const id = targetButton.dataset.id;
            const type = targetButton.dataset.type;
            const name = targetButton.dataset.name; // BARU: Ambil nama tim
            
            if (!id || !type || !currentUserId) return;

            // --- LOGIKA HAPUS (DELETE) ---
            if (type.endsWith('-delete')) {
                let docRef;
                let confirmationText = "Yakin ingin menghapus data ini?";
                
                try {
                    if (type === 'match-delete') {
                        docRef = doc(getMatchesCollection(currentUserId), id);
                        confirmationText = "Yakin hapus laga ini? Klasemen akan dihitung ulang.";
                    } else if (type === 'scorer-delete') {
                        docRef = doc(getScorersCollection(currentUserId), id);
                        confirmationText = "Yakin hapus pemain ini dari top skor?";
                    } else if (type === 'assist-delete') {
                        docRef = doc(getAssistsCollection(currentUserId), id);
                        confirmationText = "Yakin hapus pemain ini dari top assist?";
                    } else if (type === 'team-delete') { // LOGIKA BARU HAPUS TIM
                        docRef = doc(getTeamsCollection(currentUserId), id);
                        confirmationText = `Yakin hapus tim "${name}"? SEMUA laga yang dimainkan tim ini akan ikut terhapus.`;
                    }
                    
                    const didConfirm = await showCustomConfirm("Konfirmasi Hapus", confirmationText);
                    
                    if (didConfirm) {
                        await deleteDoc(docRef);
                        
                        // LOGIKA BARU: Jika menghapus tim, hapus juga laganya
                        if (type === 'team-delete') {
                            // Hapus laga dimana tim ini adalah team_a
                            const matchesAQuery = query(getMatchesCollection(currentUserId), where("team_a", "==", name));
                            const matchesASnapshot = await getDocs(matchesAQuery);
                            for (const matchDoc of matchesASnapshot.docs) {
                                await deleteDoc(matchDoc.ref);
                            }

                            // Hapus laga dimana tim ini adalah team_b
                            const matchesBQuery = query(getMatchesCollection(currentUserId), where("team_b", "==", name));
                            const matchesBSnapshot = await getDocs(matchesBQuery);
                            for (const matchDoc of matchesBSnapshot.docs) {
                                await deleteDoc(matchDoc.ref);
                            }
                            
                            // NANTI KITA PERLU HAPUS TOP SKOR & ASSIST JUGA? (Untuk nanti)
                        }
                    }
                } catch (error) {
                    console.error(`Error deleting ${type}: `, error);
                    await showCustomAlert("Error", `Gagal menghapus: ${error.message}`);
                }
            }

            // --- LOGIKA EDIT (UPDATE) ---
            if (type === 'match-edit') {
                const matchToEdit = matchesData.find(m => m.id === id);
                if (!matchToEdit) {
                    await showCustomAlert("Error", "Data laga tidak ditemukan.");
                    return;
                }

                const result = await showCustomPrompt(
                    `Edit Skor: ${matchToEdit.team_a} vs ${matchToEdit.team_b}`,
                    matchToEdit.team_a,
                    matchToEdit.team_b,
                    matchToEdit.score_a,
                    matchToEdit.score_b
                );

                if (result === null) return; 

                const { scoreA: newScoreA, scoreB: newScoreB } = result;
                if (isNaN(newScoreA) || isNaN(newScoreB) || newScoreA < 0 || newScoreB < 0) {
                    await showCustomAlert("Error", "Skor tidak valid. Harap masukkan angka 0 atau lebih.");
                    return;
                }

                try {
                    const docRef = doc(getMatchesCollection(currentUserId), id);
                    await updateDoc(docRef, {
                        score_a: newScoreA,
                        score_b: newScoreB
                    });
                } catch (error) {
                    console.error("Error updating score: ", error);
                    await showCustomAlert("Error", "Gagal meng-update skor.");
                }
            }
        });

    </script>
</body>
</html>
